# 不變量驅動的腦內 API×ADT 設計與分層正規形 v0.2

## Pre‑Processing

### General Statement
本文件整合「不變量驅動的純腦內 API & ADT 設計框架（壓縮稿 v0.1）」與「invariant_layering_plan」。以不變量作為語義核心，建立狀態、轉換、停機、邊界與單條可用 Laws 的最小組合，並以三軸分層（面向、層次、環節）消解旗標耦合與時程錯置。在教材上只採三口袋章節與三觸發規則的最短路線，確保在不依賴外部工具的前提下完成從思維到程式碼的最小可審計映射。

### Obstruction Map
| Witness | Faultline | Target | Scope | Remedy/Action | TN |
|---|---|---|---|---|---|
| 旗標爆炸導致狀態耦合 | 條件彼此牽制，無法合併 | 以殘差觀點將旗標併入狀態，做正規形化 | 正規語言／有限自動機 | 讀 Kozen Ch.15–16→13–14；用 Myhill–Nerode 決定必分與可合；最小化即正規形 | 轉 U2，立三軸與三問卡 |
| 迴圈錯誤與終止不明 | 不變量無生命期與下降量 | 只在指定階段維持 INV，明寫 Start/Stop 與下降量 | While／Parsing 層 | App. I 與 Ch.26–27 作口袋；固定單句 INV＋下降量；以 CKY 思路學會階段切換 | 轉 U3，落手操流程 |

### Macro Dependency Graph（簡表）
- Definitions: 狀態 S，轉換族 T，性質 P（不變量），停機與邊界；ADT＝⟨S, Ops, P, Laws⟩。
- Lemma: 不變量閉合；分段生命期下的局部閉合。
- Proposition: 生命週期語義＝存在一條保持 P 的狀態流自初態至停機。
- Theorem: Myhill–Nerode 與最小 DFA 的唯一性作為「狀態正規形」。

## Unit 1: 語義骨幹與 ADT 四件組

### Motivation (M)
需要一個最小而封閉的語義骨幹，使思維可直接投影為 API／ADT 並在腦內完成設計與驗證。

### Structure (S)
**定義與語義**
- 狀態與轉換：S 為可達狀態集合；T＝{T_i: S→S} 為轉換族。  
- 不變量：P: S→{⊤,⊥}，若 ∀i, s，P(s)⇒P(T_i(s))。  
- 停機：P 在考察流上失去擴展意義，或達到規定的正規形。  
- 邊界：輸入域、資源與錯誤機制對 P 的合法塑形。  
- ADT：ADT＝⟨S, Ops, P, Laws⟩；Laws 為單條可用的等價轉寫或交換律用以路徑切換。

**思維→程式碼映射**
- P 決定迴圈骨架；T 決定更新語句；邊界成為 guard；停機對應 return。

**最小測試三件組**
- 典型、邊界、負例各一；校驗 Post 與 Err。

### TN
本單元確立語義與最小實作接口。下一單元將以三軸分層消解耦合與負擔。

## Unit 2: 三軸分層（面向／層次／環節）

### Motivation (M)
以正交投影、蕴含階層與生命期管理，降低工作記憶負擔並避免旗標爆炸。

### Structure (S)
**定義**
1) 面向（獨立性）：將 S 近似拆為直積 S≅∏S_i；每條不變量 I_i 僅約束自身投影。  
2) 層次（蕴含性）：在不變量族上取蕴含序 (𝓘,⇒)；保留最小生成集，上位條件推出其餘。  
3) 環節（時程性）：為 I_i 指定生效階段 t 與交接點；越界即釋放。

**三問卡**
Q1 面向：條件能否分入互不干擾的欄位，使每條只讀本欄投影。  
Q2 層次：是否存在少數上位條件可推出其他細節。  
Q3 環節：每條不變量是否有明確 Start/Stop 與下降量。

**標籤對齊**
[INV] 三行對應獨立、蕴含、時程；[Start/Stop] 明寫下降量；[BD] 僅三條最高風險。

### TN
分層原理就位。下一單元固定落地的手操順序與最小測試卡。

## Unit 3: 手操流程（環節→面向→層次）

### Motivation (M)
考場與實作多為單通道資料流；最大風險在時序與耦合。

### Structure (S)
**順序**
1) 先環節：先寫 `Start/Stop`，定一條單句 `INV`，標明只在該階段有效。  
2) 再面向：列狀態欄位（索引、窗口、當前最佳、計數器）；能合併就合併，避免多旗標。  
3) 後層次：選一條上位條件（如處理至 i，答案覆蓋 [0..i]），其餘不寫死。

**最小測試卡**
- Gate：一句話前置（輸入域、排序、唯一、容量）。  
- Stop：一個下降量。  
- BD×3：空或極小、相等邊界、資源回退。  
- MR×1：一條可程式化輸入變形與預期輸出變化。

**散步心算模板**
單次掃描 → 一條 INV → 三檢查（空、邊界、更新時機）。

### TN
手操模板確立。下一單元綁定口袋章節與觸發規則，避免過讀。

## Unit 4: 三觸發與三口袋（最短路線）

### Motivation (M)
只在卡點查字典，最大化學習邊際效益。

### Structure (S)
**觸發條件**
(a) 寫不出單句不變量；(b) 旗標爆炸需把多旗標併成狀態；(c) 生命期不清或需證「不可能／必須」。

**口袋章節與順序**
1) Myhill–Nerode 與最小化（Ch.15–16→13–14）：決定必分可合，將旗標併入狀態，最小化即正規形。  
2) While 程式語義（App. I）：固定單句 loop INV 與下降量。  
3) Parsing／CKY（Ch.26–27 選讀）：只在當前 chart 維持 INV，明確階段交接。

### TN
讀書路徑固定。下一單元給出演算法與系統兩類例題作為骨幹模板。

## Unit 5: 例題骨幹（演算法 × 系統）

### Motivation (M)
以雙範式例題驗證三軸分層與思維→程式碼映射。

### Structure (S)
**A. BFS 最短距離（演算法層）**  
- 狀態 S＝(Q, dist, seen)。  
- 不變量：出隊順序為非遞減距離；Q 恒為「已發現未擴展」。  
- 停機：Q＝∅；不可達距離為 ∞。  
- 資源面：每點至多入隊一次；時間 O(|V|+|E|)，空間 O(|V|)。  
- 三軸定位：面向＝結構與運算正交；層次＝「處理至 i 覆蓋 [0..i]」作上位條件；環節＝擴展階段有效。

**B. NAT TTL（系統層）**  
- 不變量：TTL 單調遞減；「寫 TTL」與「讀時刪除過期」在可觀測輸出上等價。  
- Law：時間前進 ≡ 過期刪除。  
- 邊界：表滿、溢位、時鐘單調性。  
- 三軸定位：系統與運算面向分離；層次以「可觀測等價」為上位；環節以維護與回收兩段切換。

### Boundary (Bd)
- BFS：索引邊界與空圖處理；隊列操作需與 dist 更新同原子步出現。  
- NAT：要求單調時鐘；到期刪除與回寫不得交織使可觀測語義破壞。

### Condition Strengthening (Cs)
- 對 NAT 要求計時來源單一且單調，以保證等價律作為上位條件可用。

### TN
雙例題覆核三軸分層與單條 Laws 的使用。下一步導出標準筆記卡與提交格式。

## Meta‑Reflection
本文件以不變量為核，串接 ADT 四件組與三軸分層，將演算法與系統語義壓至單句 INV 與單條 Laws 的操作正規形。讀書採三觸發與三口袋，避免過度理論負擔。下一步行動：挑兩題普考與一則網路實作任務，依 Unit 3 流程落筆並附最小測試卡；若命中觸發條件再查口袋章節，否則維持封閉路線。
